/*
 * @Author: 徐横峰 
 * @Date: 2018-04-25 11:09:29 
 * @Last Modified by: 564297479@qq.com
 * @Last Modified time: 2018-04-28 14:44:28
 */

<template>
  <!-- 用户登入 、注册dialog组件 -->
  <div class="dialog">
       <!-- 用户登入start -->
		<div class="panel_login " id="dialog"  v-show="showFlag">
			<div class="panel_info">
				<i class="close_login" @click.stop="cancel()">×</i>
				<div class="panel_tab" v-if="showbox == 1">
					<div class="title">账号密码登录</div>
					<div class="inputGroup">
						<input type="text" v-model="phonenum1" placeholder="请输入手机号" maxlength="11">
						<input autocomplete="off" :type="setpassword" v-model="password1" placeholder="请输入登录密码" maxlength="20" @focus="setPsd()">
                        <div class="fr fontColor" @click="jump(4)">忘记密码</div>
                        <button @click="login()">登录</button>
                        <div class="fl fontColor" @click="jump(3)">手机快捷登录</div>
                        <div class="come_login">没有账号？<span style="color: #ff1010;cursor: pointer;" @click="jump(2)">去注册</span></div>
					</div>
				</div>
				
				<div class="panel_tab" v-if="showbox == 2">
                    <div class="title">手机号码注册</div>
					<div class="inputGroup">
						<input type="text" v-model="phonenum2" placeholder="请输入手机号" maxlength="11">
						<div class="login_input_resgize"><input type="text" v-model="msgcode1" placeholder="请输入验证码"><button @click="sendMsgCode(1)">获取验证码</button></div>
						<input type="password" v-model="password2" placeholder="请输入密码（最少六位，数字加字母）" maxlength="11">
						<input type="password" v-model="password3" placeholder="请再次输入密码" maxlength="11">
                        <div class="fontColor"><label class="check"><input type="checkbox"></input><span>同意</span><span style="color: red;">《世华服务协议》</span></label></div>
                        <button @click="register()">注册</button>
                        <div class="come_login" style="margin-top: 15px;">已有账号？<span style="color: #ff1010;cursor: pointer;" @click="jump(1)">去登录</span></div>
					</div>
				</div>

				<div class="panel_tab" v-if="showbox == 3">
                    <div class="title">手机快捷登陆</div>
					<div class="inputGroup">
						<input type="text" v-model="phonenum3" placeholder="请输入手机号" maxlength="11">
						<div class="login_input_resgize"><input type="text" v-model="msgcode2" placeholder="请输入验证码"><button @click="sendMsgCode(2)">获取验证码</button></div>
                        <button @click="rapid()">登录</button>
                        <div class="dl_login"  @click="login()">账号密码登录</div>
                        <div class="come_login">没有账号？<span style="color: #ff1010;cursor: pointer;" @click="jump(2)">去注册</span></div>
					</div>
				</div>

				<div class="panel_tab" v-if="showbox == 4">
                    <div class="title">找回密码</div>
					<div class="inputGroup">
						<input type="text" v-model="phonenum4" placeholder="请输入手机号" maxlength="11">
						<div class="login_input_resgize">
              <input type="text" v-model="msgcode3" placeholder="请输入验证码"><button :class="disabled?'sendCode':''" ref="sendCode" @click="sendMsgCode(3)">获取验证码</button>
            </div>
						<input type="password" v-model="password4" placeholder="请输入密码(最少六位,数字加字母)">
						<input type="password" v-model="password5" placeholder="再次输入密码">
                        <button @click="findPassword()">确定</button>
                        <div class="come_login" style="margin-top: 15px;">已有账号？<span style="color: #ff1010;cursor: pointer;" @click="jump(2)">去注册</span></div>
					</div>
				</div>
			</div>
		</div>
		<!-- 用户登入end -->
        <div class="shadowlay" v-if="showFlag" @click="cancel()"></div>
  </div>
</template>
<script>
import md5 from "js-md5";
export default {
  props: {
    showbox: {
      //对应的内容
      type: Number,
      value: ""
    }
  },
  data() {
    return {
      setpassword: 'text',//文本域
      //1去登入
      phonenum1: null, //手机号
      password1: null, //密码

      //2去注册
      phonenum2: null,
      password2: null,
      password3: null,
      msgcode1: null, //验证码

      //3点击手机快捷登录
      phonenum3: null,
      msgcode2: null,

      //4点击找回密码
      phonenum4: null,
      password4: null,
      password5: null,
      msgcode3: null,

      //状态判断
      showFlag: false,
      disabled: false
    };
  },
  methods: {
    setPsd(e) {
      this.setpassword='password';
    },
    show() {
      this.showFlag = true;
    },
    hide() {
      this.showFlag = false;
    },
    cancel() {
      this.hide();
    },
    login() {
      //登录
      this.$http
        .post(this.$url.URL.USER_LOGIN, {
          deviceCode: "web",
          mobile: this.phonenum1,
          password: this.password1
        })
        .then(res => {
          if(res.status == 200) {
            this.cancel();
            this.$message({
              message: "登录成功",
              type: 'success'
            });
            sessionStorage.token=res.data.data;
            this.$store.dispatch('login');
          }else{
            this.$alert(res.data.msg);
          }
        });
    },
    register() {//注册
      if (
        !this.phonenum2 ||
        !this.password2 ||
        !this.password3 ||
        this.password2 !== this.password3
      ) {
        this.cancel();
        return this.$alert("填写信息不完整!");
      }
      this.$http
        .post(this.$url.URL.USER_REGISTER, {
          deviceCode: "web",
          mobile: this.phonenum2,
          password: this.password2,
          smsCode: this.msgcode1
        })
        .then(res => {
          console.log(res)
          console.log(res.status)
          if(res.status == 200) {
            this.cancel();
            this.$alert("注册成功!");
            localStorage.token=res.data.data;
            console.log(res.data)
          }else{
            this.$alert(res.data.msg);
          }
        });
    },
    rapid() {//快捷登录 接口有问题
      this.$http
        .post(this.$url.URL.SMSCODE_LOGIN, {
          deviceCode: "web",
          mobile: this.phonenum3,
          password: "string", ///??????
          smsCode: this.msgcode2
        })
        .then(res => {
          if (res.data.status == "500") {
            this.$alert(res.data.msg);
          }
        });
    },
    findPassword() {//找回密码 (设置密码登录)
      this.$http
        .post(this.$url.URL.SMSCODE_RESETLOGIN, {
          confirmPassword: this.password4,
          mobile: this.phonenum4,
          newPassword: this.password5,
          smsCode: this.msgcode3
        })
        .then(res => {
          if(res.status == 200) {
            this.$alert('修改成功！', {
              confirmButtonText: '确定',
              callback: () => {
                this.jump(1);
              }
            })
          }else{
            this.$alert(res.data.msg);
          }
        });
    },
    countDown() {//验证码倒计时
      let timer,times=60;
      timer = setInterval(()=> {
        times--;
        if (times <= 0) {
            times = 0; 
            clearInterval(timer);
            this.disabled=false;
            this.$refs.sendCode.innerHTML = '获取验证码';
        } else {
            this.disabled=true;
            this.$refs.sendCode.innerHTML = times + '秒后重试';
        }
      }, 1000);
    },
    sendMsgCode(num) {//发送验证码
      if(!this.disabled) {
        let mobile, operateType;
        if (num == 1) {
          mobile = this.phonenum2;
          operateType = "REGISTER";
        } else if (num == 2) {
          mobile = this.phonenum3;
          operateType = "LOGIN";
        } else if (num == 3) {
          mobile = this.phonenum4;
          operateType = "RESET_PASSWORD";
        }
        //非空校验 正则校验
        if(mobile == undefined) {
          return this.$alert('手机不能为空!');
        }else if(!(/^1[34578]\d{9}$/).test(mobile)) {
          return this.$alert('手机格式不对!');
        }else{
          this.countDown();
        }

        //手机号签名
        let key = mobile + "29e94f94-8664-48f2-a4ff-7a5807e13b68";
        this.$http.post(this.$url.URL.FETCHSMSCODE, {
          deviceCode: "web",
          mobile: mobile,
          operateType: operateType,
          sign: md5(key.toUpperCase())
        })
        .then(res => {
          if (res.data.status == "500") {
            this.$alert(res.data.msg);
          }
        });
      } 
    },
    // if (!/^(?![0-9]+$)(?![a-zA-Z]+$)[0-9A-Za-z]{8,16}$/.test(this.password)) {
    //     this.$alert("必须是8~16位含字母和数字的密码");
    //     this.password = "";
    //   }
    /**
     *num 1去登入 2去注册 3点击手机快捷登录 4点击找回密码
     */
    jump(num) {
      this.$emit("changeDialog", num);
    }
  }
};
</script>
<style lang="less" scoped>
.shadowlay {
  position: fixed;
  top: 0;
  right: 0;
  left: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.5);
  z-index: 995;
}

/*登陆注册*/
.panel_login {
  width: 381px;
  background-color: #fff;
  position: fixed;
  z-index: 999;
  left: 50%;
  top: 50%;
  margin-left: -190px;
  margin-top: -205px;
  box-shadow: 1px 3px 14px rgba(0, 0, 0, 0.3);
  -moz-box-shadow: 1px 3px 14px rgba(0, 0, 0, 0.3);
  -webkit-box-shadow: 1px 3px 14px rgba(0, 0, 0, 0.3);
  -o-box-shadow: 1px 3px 14px rgba(0, 0, 0, 0.3);
  border-radius: 2px;
}
.panel_login .panel_info {
  padding: 40px 0 40px;
}
.panel_login .panel_info .close_login {
  cursor: pointer;
  position: absolute;
  right: 15px;
  top: 15px;
  padding: 4px;
  color: #000000;
}
.panel_login .panel_tab .title {
  font-size: 20px;
  color: #333;
  font-weight: bold;
  text-align: center;
  cursor: pointer;
}
.inputGroup {
  width: 282px;
  margin: 0 auto;
}
.inputGroup input {
  height: 43px;
  width: 100%;
  line-height: 43px;
  color: #000000;
  text-indent: 16px;
  margin-top: 10px;
  border-radius: 3px;
  border: 1px solid #999999;
}
.inputGroup button {
  width: 100%;
  background: red;
  height: 45px;
  line-height: 43px;
  border-radius: 5px;
  cursor: pointer;
  font-size: 14px;
  color: #ffffff;
  border: 0px;
  margin-top: 10px;
  outline: none;
}
input::-webkit-input-placeholder {
  color: #cacaca;
  font-size: 15px;
}

.login_input_resgize > input {
  width: 160px;
  height: 43px;
  line-height: 43px;
  color: #333333;
  margin-top: 10px;
}

.login_input_resgize > button {
  float: right;
  background: red;
  width: 108px;
  height: 45px;
  line-height: 43px;
  border-radius: 5px;
  cursor: pointer;
  font-size: 14px;
  color: #ffffff;
  border: 0px;
  margin-top: 10px;
}
input[type="checkbox"] {
  width: 20px;
  height: 20px;
  float: left;
  margin: 0 !important;
}
.dl_login {
  position: absolute;
  left: 50px;
  color: #000000;
  font-size: 14px;
  margin-top: 10px;
  cursor: pointer;
}
.come_login {
  height: 16px;
  font-size: 16px;
  margin-top: 46px;
  text-align: center;
  color: #000000;
}
.fontColor {
  margin-top: 10px;
  color: #000000;
}

/* 发送验证码 */
.sendCode{
  background: rgba(0, 0, 0, 0.3)!important;
}


/*底部*/
</style>


